<!DOCTYPE html>
<html>
<head>
  <title>Basic 3D World</title>
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <link rel="stylesheet" type="text/css" href="base.css">
</head>

<body>
    <script id="vertexShader", type="x-shader/x-vertex">
        void main() {
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
    </script>
    <script id="fragmentShader", type="x-shader/x-fragment">
        uniform sampler2D map;
        
        void main() {

            vec2 uv = gl_FragCoord.xy / vec2(1024.0, 1024.0);
        
            vec4 textureValue = texture2D(map, uv);
            gl_FragColor = textureValue;
        }
    </script>
    <script id="textureShader", type="x-shader/x-fragment">
        uniform sampler2D textureSampler;

        void main() {

            vec2 uv = gl_FragCoord.xy / vec2(512.0, 512.0);

            vec4 textureValue = texture2D(textureSampler, uv);
            gl_FragColor = textureValue;
        }
    </script>
    <script id="advectShader", type="x-shader/x-fragment">
        uniform sampler2D velocitySampler;
        uniform float timestep;

        void main() {
            vec2 uv = vec2(gl_FragCoord.x, gl_FragCoord.y) / vec2(512.0, 512.0);
            vec2 textureValue = texture2D(velocitySampler, uv).xy;

            vec2 uvOld = vec2(gl_FragCoord.x - textureValue.x * timestep, gl_FragCoord.y - textureValue.y * timestep) / vec2(512.0, 512.0);
            vec2 textureValueOld = texture2D(velocitySampler, uvOld.xy).xy;
            
            
            
            gl_FragColor = vec4(textureValueOld, 0.0, 1.0);
            
            if (uv.x > 0.4 && uv.x < 0.6 && uv.y < 0.06 && uv.y > 0.0) {
                gl_FragColor = vec4(textureValueOld, 0.0, 1.0) + vec4(0.0, 0.2, 0.0, 1.0);
            }
        }
    </script>
    <script id="divergenceShader", type="x-shader/x-fragment">
        uniform sampler2D velocitySampler;

        void main() {
            vec2 invRes = vec2(1.0, 1.0) / vec2(512.0, 512.0);
            vec2 uv = gl_FragCoord.xy * invRes;

            float x0 = texture2D(velocitySampler, uv - vec2(invRes.x, 0)).x;
            float x1 = texture2D(velocitySampler, uv + vec2(invRes.x, 0)).x;
            float y0 = texture2D(velocitySampler, uv - vec2(0, invRes.y)).y;
            float y1 = texture2D(velocitySampler, uv - vec2(0, invRes.y)).y;

            float divergence = ((x1 - x0) + (y1 - y0)) * 0.5;
            gl_FragColor = vec4(divergence);
        }
    </script>

    <script id="jacobiShader", type="x-shader/x-fragment">
        uniform sampler2D velocitySampler;
        uniform sampler2D pressureSampler;
        uniform sampler2D divergenceSampler;

        float samplePressure(vec2 pos) {
            if (pos.x > 1.0 || pos.y > 1.0 || pos.x < 0.0 || pos.y < 0.0) {
                return 0.0;
            }
            else {
                return texture2D(pressureSampler, pos).x;
            }
        }

        void main() {
            vec2 invRes = vec2(1.0, 1.0) / vec2(512.0, 512.0);
            vec2 uv = gl_FragCoord.xy * invRes;

            float div = texture2D(divergenceSampler, uv).x;
            float x0 = samplePressure(uv - vec2(invRes.x, 0));
            float x1 = samplePressure(uv + vec2(invRes.x, 0));
            float y0 = samplePressure(uv - vec2(0, invRes.y));
            float y1 = samplePressure(uv - vec2(0, invRes.y));

            float jacobiOutput = (x0 + x1 + y0 + y1 - div) * 0.25;
            gl_FragColor = vec4(jacobiOutput);
        }
    </script>

    <script id="outputShader", type="x-shader/x-fragment">
        uniform sampler2D velocitySampler;
        uniform sampler2D pressureSampler;

        void main() {
            vec2 invRes = vec2(1.0, 1.0) / vec2(512.0, 512.0);
            vec2 uv = gl_FragCoord.xy * invRes;
            float x0 = texture2D(pressureSampler, uv - vec2(invRes.x, 0)).x;
            float x1 = texture2D(pressureSampler, uv + vec2(invRes.x, 0)).x;
            float y0 = texture2D(pressureSampler, uv - vec2(0, invRes.y)).x;
            float y1 = texture2D(pressureSampler, uv - vec2(0, invRes.y)).x;

            vec2 pressureGradient = (vec2(x1, y1) - vec2(x0, y0)) * 0.5;
            vec2 oldV = texture(velocitySampler, uv).xy;
            gl_FragColor = vec4(oldV - pressureGradient, 0.0, 1.0);
        }
    
    </script>
	<script src="./fluid_main.js"  type="module"></script>

</body>
</html>